<!-- Licensed under GPLv3 - See LICENSE file for details. -->
{% load filter %}
<form id="email-site-form" class="calcite-form" autocomplete="off" aria-label="Email server configuration">
  {% csrf_token %}
  <div class="flex-container flex-column-gap-1">
    <div class="col-50">
      <calcite-input type="text" id="{{ form.email_host.name }}" name="{{ form.email_host.name }}"
                     autocomplete="off" value="{{ form.email_host.value|default_if_none:'' }}"
                     label-text="SMTP Server Address" required
                     status="{% if form.email_host.errors %}invalid{% else %}idle{% endif %}"
                     validation-message="{{ form.email_host.errors|join:' ' }}"
                     validation-icon="{% if form.email_host.errors %}exclamation-mark-triangle{% endif %}">
        <calcite-icon slot="label-content" id="address-tooltip" icon="information" scale="s"></calcite-icon>
      </calcite-input>
    </div>
    <div class="col-50">
      <calcite-input type="number" id="{{ form.email_port.name }}" name="{{ form.email_port.name }}"
                     autocomplete="off" value="{{ form.email_port.value|default_if_none:'' }}"
                     number-button-type="none" label-text="SMTP Port" required
                     min="1" max="65535"
                     status="{% if form.email_port.errors %}invalid{% else %}idle{% endif %}"
                     validation-message="{{ form.email_port.errors|join:' ' }}"
                     validation-icon="{% if form.email_port.errors %}exclamation-mark-triangle{% endif %}">
        <calcite-icon slot="label-content" id="port-tooltip" icon="information" scale="s"></calcite-icon>
      </calcite-input>
    </div>
  </div>

  <calcite-select name="{{ form.email_encryption.name }}" id="{{ form.email_encryption.name }}"
                  value="{{ form.email_encryption.value }}"
                  label="Encryption Method" required
                  status="{% if form.email_encryption.errors %}invalid{% else %}idle{% endif %}"
                  validation-message="{{ form.email_encryption.errors|join:' ' }}"
                  validation-icon="{% if form.email_encryption.errors %}exclamation-mark-triangle{% endif %}">
    <calcite-icon slot="label-content" id="encryption-tooltip" icon="information" scale="s"></calcite-icon>
    <calcite-option value="plain_text" label="Plain Text (No Encryption)">Plain Text</calcite-option>
    <calcite-option value="starttls" label="StartTLS">StartTLS</calcite-option>
    <calcite-option value="ssl" label="SSL/TLS">SSL</calcite-option>
  </calcite-select>

  <calcite-input type="email" id="{{ form.from_email.name }}" name="{{ form.from_email.name }}"
                 autocomplete="email" value="{{ form.from_email.value|default_if_none:'' }}"
                 label-text="Sender Address" required
                 status="{% if form.from_email.errors %}invalid{% else %}idle{% endif %}"
                 validation-message="{{ form.from_email.errors|join:' ' }}"
                 validation-icon="{% if form.from_email.errors %}exclamation-mark-triangle{% endif %}">
    <calcite-icon slot="label-content" id="sender-tooltip" icon="information" scale="s"></calcite-icon>
  </calcite-input>

  <calcite-input type="email" id="{{ form.reply_to.name }}" name="{{ form.reply_to.name }}"
                 autocomplete="email" value="{{ form.reply_to.value|default_if_none:'' }}"
                 label-text="Reply To"
                 status="{% if form.reply_to.errors %}invalid{% else %}idle{% endif %}"
                 validation-message="{{ form.reply_to.errors|join:' ' }}"
                 validation-icon="{% if form.reply_to.errors %}exclamation-mark-triangle{% endif %}">
    <calcite-icon slot="label-content" id="reply-tooltip" icon="information" scale="s"></calcite-icon>
  </calcite-input>

  <div class="flex-container flex-column-gap-1">
    <div class="col-50">
      <calcite-input type="text" id="{{ form.email_username.name }}" name="{{ form.email_username.name }}"
                     autocomplete="username" value="{{ form.email_username.value|default_if_none:'' }}"
                     label-text="Username"
                     status="{% if form.email_username.errors %}invalid{% else %}idle{% endif %}"
                     validation-message="{{ form.email_username.errors|join:' ' }}"
                     validation-icon="{% if form.email_username.errors %}exclamation-mark-triangle{% endif %}">
        <calcite-icon slot="label-content" id="username-tooltip" icon="information" scale="s"></calcite-icon>
      </calcite-input>
    </div>
    <div class="col-50">
      <calcite-input type="password" id="{{ form.email_password.name }}" name="{{ form.email_password.name }}"
                     autocomplete="current-password"
                     label-text="Password"
                     status="{% if form.email_password.errors %}invalid{% else %}idle{% endif %}"
                     validation-message="{{ form.email_password.errors|join:' ' }}"
                     validation-icon="{% if form.email_password.errors %}exclamation-mark-triangle{% endif %}"></calcite-input>
    </div>
  </div>

  <calcite-input type="email" id="test-email" name="test_email" placeholder="Enter an email address"
                 label-text="Send Test Email"
                 autocomplete="email">
    <calcite-button slot="action" id="email-portal-test"
                    hx-post="{% url 'enterpriseviz:email_settings' %}"
                    hx-include="#email-site-form" hx-vals='{"action": "test_email"}'
                    hx-target="#email-site-form"
                    label="Send test email">
      Send
    </calcite-button>
  </calcite-input>

  {% if form.non_field_errors %}
    <calcite-notice open status="danger" icon>
      <div slot="message">{{ form.non_field_errors|join:" " }}</div>
    </calcite-notice>
  {% endif %}

</form>

<calcite-tooltip reference-element="address-tooltip" close-on-click placement="bottom-start">
  <span>The hostname or IP address of your SMTP email server</span>
</calcite-tooltip>
<calcite-tooltip reference-element="port-tooltip" close-on-click placement="bottom-start">
  <span>The port number for SMTP connection (typically 25, 465, or 587)</span>
</calcite-tooltip>
<calcite-tooltip reference-element="encryption-tooltip" close-on-click placement="bottom-start">
  <span>Select the encryption method supported by your SMTP server</span>
</calcite-tooltip>
<calcite-tooltip reference-element="sender-tooltip" close-on-click placement="bottom-start">
  <span>The email address that will appear as the sender of outgoing emails</span>
</calcite-tooltip>
<calcite-tooltip reference-element="reply-tooltip" close-on-click placement="bottom-start">
  <span>Optional: Email address where replies should be directed</span>
</calcite-tooltip>
<calcite-tooltip reference-element="username-tooltip" close-on-click placement="bottom-start">
  <span>Username for SMTP authentication (if required by your server)</span>
</calcite-tooltip>
