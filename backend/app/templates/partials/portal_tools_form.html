{% load filter %}
<form id="tools-portal-form" class="calcite-form" autocomplete="off">
  {% csrf_token %}
  <calcite-input type="text" id="{{ form.instance.name }}" name="{{ form.instance.name }}" read-only="true"
                 autocomplete="off" value="{{ instance_alias }}" hidden></calcite-input>

  <calcite-accordion selection-mode="single">
    <!-- ArcGIS Pro License Removal Tool -->
    <div id="progress-container">
      <div class="progress_bar" id="progress-bar"></div>
    </div>
    <calcite-accordion-item
      class="tool-section"
      data-tool-id="1"
      heading="ArcGIS Pro License Removal"
      description="Remove ArcGIS Pro licenses from inactive users. Based on AGOL/Portal ArcGIS Pro activity last used."
      icon-start="license">

      <div slot="actions-end" class="accordion-actions-end">
        <calcite-switch id="tool-pro-license-enabled" data-tool-toggle="1"
                        {% if form.tool_pro_license_enabled.value %}checked{% endif %}
                        scale="s"></calcite-switch>
        <input type="hidden" name="tool_pro_license_enabled"
               value="{{ form.tool_pro_license_enabled.value|yesno:'True,False' }}">
      </div>

      <div class="tool-settings">
        <calcite-label>
          Inactivity Duration
          <calcite-select id="tool-pro-duration" name="tool_pro_duration"
                          value="{{ form.tool_pro_duration.value|default_if_none:'' }}">
            <calcite-option value="30">30 days</calcite-option>
            <calcite-option value="60">60 days</calcite-option>
            <calcite-option value="90">90 days</calcite-option>
            <calcite-option value="180">180 days</calcite-option>
          </calcite-select>
          <calcite-input-message {% if not form.tool_pro_duration.errors %}hidden{% endif %}
                                 icon="exclamation-mark-triangle-f" status="invalid">
            {{ form.tool_pro_duration.errors|join:" " }}
          </calcite-input-message>
        </calcite-label>
        <calcite-label>
          Warning Notification
          <calcite-select id="tool-pro-warning" name="tool_pro_warning"
                          value="{{ form.tool_pro_warning.value|default_if_none:'' }}">
            <calcite-option value="3">3 days</calcite-option>
            <calcite-option value="5">5 days</calcite-option>
            <calcite-option value="7">7 days</calcite-option>
            <calcite-option value="14">14 days</calcite-option>
          </calcite-select>
          <calcite-input-message {% if not form.tool_pro_warning.errors %}hidden{% endif %}
                                 icon="exclamation-mark-triangle-f" status="invalid">
            {{ form.tool_pro_warning.errors|join:" " }}
          </calcite-input-message>
        </calcite-label>
      </div>
      <calcite-button id="run-pro-removal" scale="s"
                      hx-post="{% url 'enterpriseviz:tools_run' instance=form.instance.portal.alias tool_name='pro_license' %}"
                      hx-target="previous #progress-container"
                      hx-include="#tools-portal-form"
                      icon-start="play">
        Run Now
      </calcite-button>
    </calcite-accordion-item>

    <!-- Public Item Unsharing Tool -->
    <div id="progress-container">
      <div class="progress_bar" id="progress-bar"></div>
    </div>
    <calcite-accordion-item
      class="tool-section"
      data-tool-id="2"
      heading="Public Item Unsharing"
      description="Unshare publicly shared items that do not meet metadata requirements. Based on AGOL/Portal metadata score completeness."
      icon-start="share">

      <div slot="actions-end" class="accordion-actions-end">
        <calcite-switch id="tool-public-unshare-enabled" data-tool-toggle="2"
                        {% if form.tool_public_unshare_enabled.value %}checked{% endif %}
                        scale="s"></calcite-switch>
        <input type="hidden" name="tool_public_unshare_enabled"
               value="{{ form.tool_public_unshare_enabled.value|yesno:'True,False' }}">
      </div>

      <div class="tool-settings">
        <calcite-label>
          Metadata Score Requirement
          <calcite-select id="tool-public-unshare-score" name="tool_public_unshare_score"
                          value="{{ form.tool_public_unshare_score.value|default_if_none:'' }}">
            <calcite-option value="50">50%</calcite-option>
            <calcite-option value="75">75%</calcite-option>
            <calcite-option value="90">90%</calcite-option>
            <calcite-option value="100">100%</calcite-option>
          </calcite-select>
          <calcite-input-message {% if not form.tool_public_unshare_score.errors %}hidden{% endif %}
                                 icon="exclamation-mark-triangle-f" status="invalid">
            {{ form.tool_public_unshare_score.errors|join:" " }}
          </calcite-input-message>
        </calcite-label>
        <calcite-label>
          Notification Alert Frequency Limit
          <calcite-select id="tool_public_unshare_notify_limit" name="tool_public_unshare_notify_limit"
                          value="{{ form.tool_public_unshare_notify_limit.value|default_if_none:'' }}">
            <calcite-option value="1">1 hour</calcite-option>
            <calcite-option value="4">4 hours</calcite-option>
            <calcite-option value="12">12 hours</calcite-option>
            <calcite-option value="24">24 hours</calcite-option>
          </calcite-select>
          <calcite-input-message {% if not form.tool_public_unshare_notify_limit.errors %}hidden{% endif %}
                                 icon="exclamation-mark-triangle-f" status="invalid">
            {{ form.tool_public_unshare_notify_limit.errors|join:" " }}
          </calcite-input-message>
        </calcite-label>
        <calcite-label>
          Trigger
          <calcite-select id="tool-public-unshare-trigger" name="tool_public_unshare_trigger"
                          value="{{ form.tool_public_unshare_trigger.value|default_if_none:'' }}">
            <calcite-option value="webhook">Webhook (immediate)</calcite-option>
            <calcite-option value="daily">Daily (delayed)</calcite-option>
          </calcite-select>
          <calcite-input-message {% if not form.tool_public_unshare_trigger.errors %}hidden{% endif %}
                                 icon="exclamation-mark-triangle-f" status="invalid">
            {{ form.tool_public_unshare_trigger.errors|join:" " }}
          </calcite-input-message>
        </calcite-label>
      </div>
      <calcite-button id="run-public-unshare" scale="s"
                      hx-post="{% url 'enterpriseviz:tools_run' instance=form.instance.portal.alias tool_name='public_unshare' %}"
                      hx-target="previous #progress-container"
                      hx-include="#tools-portal-form"
                      icon-start="play">
        Run Now
      </calcite-button>
    </calcite-accordion-item>

    <!-- Inactive User Management Tool -->
    <div id="progress-container">
      <div class="progress_bar" id="progress-bar"></div>
    </div>
    <calcite-accordion-item
      class="tool-section"
      data-tool-id="3"
      heading="Inactive User Management"
      description="Manage portal users based on their last login date. Actions include notification, disabling, deletion, or content transfer."
      icon-start="user-risk">

      <div slot="actions-end" class="accordion-actions-end">
        <calcite-switch id="tool-inactive-user-enabled" data-tool-toggle="3"
                        {% if form.tool_inactive_user_enabled.value %}checked{% endif %}
                        scale="s"></calcite-switch>
        <input type="hidden" name="tool_inactive_user_enabled"
               value="{{ form.tool_inactive_user_enabled.value|yesno:'True,False' }}">
      </div>

      <div class="tool-settings">
        <calcite-label>
          Inactivity Duration
          <calcite-select id="tool-inactive-user-duration" name="tool_inactive_user_duration"
                          value="{{ form.tool_inactive_user_duration.value|default_if_none:'' }}">
            <calcite-option value="30">30 days</calcite-option>
            <calcite-option value="60">60 days</calcite-option>
            <calcite-option value="90">90 days</calcite-option>
            <calcite-option value="180">180 days</calcite-option>
            <calcite-option value="365">365 days</calcite-option>
          </calcite-select>
          <calcite-input-message {% if not form.tool_inactive_user_duration.errors %}hidden{% endif %}
                                 icon="exclamation-mark-triangle-f" status="invalid">
            {{ form.tool_inactive_user_duration.errors|join:" " }}
          </calcite-input-message>
        </calcite-label>
        <calcite-label>
          Warning Notification
          <calcite-select id="tool-inactive-user-warning" name="tool_inactive_user_warning"
                          value="{{ form.tool_inactive_user_warning.value|default_if_none:'' }}">
            <calcite-option value="3">3 days</calcite-option>
            <calcite-option value="5">5 days</calcite-option>
            <calcite-option value="7">7 days</calcite-option>
            <calcite-option value="14">14 days</calcite-option>
            <calcite-option value="30">30 days</calcite-option>
          </calcite-select>
          <calcite-input-message {% if not form.tool_inactive_user_warning.errors %}hidden{% endif %}
                                 icon="exclamation-mark-triangle-f" status="invalid">
            {{ form.tool_inactive_user_warning.errors|join:" " }}
          </calcite-input-message>
        </calcite-label>
        <calcite-label>
          Action
          <calcite-select id="tool-inactive-user-action" name="tool_inactive_user_action"
                          value="{{ form.tool_inactive_user_action.value|default_if_none:'' }}">
            <calcite-option value="notify">Notify Only</calcite-option>
            <calcite-option value="disable">Disable User</calcite-option>
            <calcite-option value="delete">Delete User</calcite-option>
            <calcite-option value="transfer">Transfer User Content</calcite-option>
          </calcite-select>
          <calcite-input-message {% if not form.tool_inactive_user_action.errors %}hidden{% endif %}
                                 icon="exclamation-mark-triangle-f" status="invalid">
            {{ form.tool_inactive_user_action.errors|join:" " }}
          </calcite-input-message>
        </calcite-label>
      </div>
      <calcite-button id="run-inactive-user" scale="s"
                      hx-post="{% url 'enterpriseviz:tools_run' instance=form.instance.portal.alias tool_name='inactive_user' %}"
                      hx-target="previous #progress-container"
                      hx-include="#tools-portal-form"
                      icon-start="play">
        Run Now
      </calcite-button>
    </calcite-accordion-item>
  </calcite-accordion>
</form>
